\section{Optimal hedge ratio}\label{sec:optimal-hedge-ratio}

\subsection{Distribution of hedge portfolio}\label{subsec:DHP}
We form a portfolio with two assets, a spot asset and a futures
contract, for example Bitcoin spot and a CME Bitcoin futures contract.
Our objective is to minimize the risk of the exposure in the spot.
To keep a simple portfolio setting, we go long one unit of the spot
and short $h$ units of the future, $h \geq 0$.
Letting $R^S$ and $R^F$ be the (discrete) returns of the spot and
futures price. The (discrete) return of the portfolio is\footnote{%
This is equivalent to stating that if both the spot price $S_{t-1}$
and the futures price $F_{t-1}$ are 
normalised to $1$, then $h$ units of the future will hedge the value
change $\Delta V = \Delta S - h \Delta F$, where $\Delta S =
S_t-S_{t-1}$, etc.
  }
\begin{equation*}
R^h = R^S -h R^F.
\end{equation*}


If the portfolio reduces the risk of the spot position, then
we call this a hedge portfolio.
To measure risk, we define a risk measures $\rho$ to be a mapping from
a financial position, such as $R^h$, to a real number, which is often
interpreted as the amount of money to make the position acceptable
(e.g.\ to a regulator), see e.g.\ \citep{Foellmer2002}.

An optimal hedge ratio (OHR) $h^*$ is a parameter that
minimizes the risk of the aforementioned portfolio
\begin{equation*}
h^* = \argmin_h \rho(R^h).
\end{equation*}

For example, Value-at-Risk (VaR) at the confidence level $\alpha$ is
the absolute value of the $1-\alpha$-quantile of $R^h$, i.e., $\text{VaR}_{1-\alpha} =
-F_{R^h}^{(-1)}(1-\alpha) = -\inf\{x \in \mathbb{R}: 1-\alpha \leq
F_{R^h}(x) \}$, where $F_{R^h}$ is the distribution function of
$R^h$.

Obviously the cdf of $R^h$ and the risk measure depend on the joint distribution of $R^S$ and $-hR^F$.

Optimising $h$ according to $f_{R^S,-hR^F}$ is unfavorable in the
sense that one would need to calibrate the joint pdf $f_{R^S,-hR^F}$
whenever updating $h$.
Another problem of using the joint pdf is that one lacks the
flexibility to model the margins separately from the dependence structure.
To overcome both of these problems, we use copulae.

The benefit of using copulae is two fold.
First, copulae are invariant under strictly
monotone increasing function \citep{schweizer1981nonparametric}, see the Lemma below.
Second, copulae allow us to model the  margins and dependence structure separately, see Sklar's Theorem
\citep{Sklar1959}.
See also \citep{Nelsen1999, joe1997multivariate, McNeil2005} for Sklar's Theorem.

\begin{theorem}[Hoeffding Sklar Theorem]
  Let $F$ be a joint distribution function with margins $F_X,
  F_Y$. Then, there exists a copula $C:[0,1]^2 \mapsto [0,1]$ such
  that, for all $x,y\in \R$
  \begin{equation}
    \label{eq:4}
    F(x,y)=C\{F_X(x), F_Y(y)\}.
  \end{equation}
  If the margins are continuous, then $C$ is unique; otherwise $C$ is
  unique on the range of the margins.

  Conversely, if $C$ is a copula and $F_X, F_Y$ are univariate
  distribution functions, then the function $F$ defined by (\ref{eq:4})
  is a joint distribution function with margins $F_X, F_Y$.
\end{theorem}

Indeed, many basic results about copulae can be traced back to early
works of Wassily Hoeffding \citep{hoedffding1940, hoedffding1941}. 
The works aimed to derive a measure of relationship of variables,
which is invariant under change of scale. 
See also \citet{hoeffding2012collected} for English translations of
the original papers written in German. 
%The following Lemma is not hard to prove.

\begin{lemma}
  \begin{align}
  C_{X, hY}\left(F_X(s),F_{hY}(t)\right) = C_{X, Y}\left(F_X(s),F_{Y}(t/h)\right).
    \end{align}
  \end{lemma}

\begin{proof}
  Since copulae are invariant under strictly monotone increasing function \cite[Theorem 3 (i)]{schweizer1981nonparametric},
  \begin{align*}
    C_{X, hY}\left(F_X(s),F_{hY}(t)\right) = C_{X, Y}\left(F_X(s),F_{hY}(t)\right).
    \end{align*}

  We rewrite second argument of the copula
  \begin{align*}
    F_{hY}(t) &= \mathbb{P}(hY \leq t)\\
              &= \mathbb{P}(Y \leq t/h)\\
              &= F_Y(t/h),
    \end{align*}
  and finish the proof.
  \end{proof}

%The optimal hedge ratio is $h^\ast = \argmin_h \rho(Z)$, that is the best ratio that can minimize the risk of a hedged portfolio measured in terms of $\rho$ .
Leveraging these two features of copulae, \citet{barbi2014copula}
introduce the distribution of linear combinations of random variables
using copulae. 
We slightly edit the Corollary 2.1 of their work and yield the
following expression of the distribution. 

\begin{proposition}
  \label{prop:dfrh}
  Let $X$ and $Y$ be two real-valued continuous random
  variables on a
  probability space $(\Omega, \F, \p)$ with
  absolutely continuous copula $C_{X, Y}$ and marginal distribution functions $F_{X}$
  and $F_{Y}$. Then, the distribution function of $Z$ is given by 
  \begin{equation}
    \label{eq:3}
    F_{Z}(z) = 1- \int^1_0 D_1 C_{X, Y}
    \left[ u, F_{Y} \left\{ \frac{F^{(-1)}_{X}(u)-z}{h} \right\}
    \right]\, d u.
  \end{equation}
\end{proposition}
Here, $F^{(-1)}$ denotes the inverse of $F$, i.e., the quantile
function.

Here $D_1 C(u,v)=\displaystyle \frac{\partial}{\partial u} C(u,v)$ and, see e.g.\ Equation (5.15) of
\citep{McNeil2005},
\begin{equation}
  \label{eq:1}
  D_1 C_{X,Y}\{F_X(x), F_Y(y)\} = \p(Y\leq y|X=x).
\end{equation}
\begin{proof}
  Using the identity (\ref{eq:1}) gives
  \begin{align*}
    F_{Z}(z) &= \p(X - h Y\leq z) %
                 = \E\left\{\p\left(Y\geq \frac{X-z}{h}\Big|
                 X\right)\right\}\\[10pt]
               &= 1-\E\left\{\p\left(Y\leq \frac{X-z}{h}\Big|
                 X\right)\right\}% \\[10pt]
               = 1- \int_0^1 D_1 C_{X, Y}\left[u,
                 F_{Y}\left\{\frac{F^{(-1)}_{X}(u) -
                 z}{h}\right\}\right]\, d u.
  \end{align*}
  \end{proof}

%In addition to~\cite{barbi2014copula} we propose a more handy
%expression for the pdf of $Z$.
%\natp{\em [Please double-check the ``+'' signs in the second equation.]}\ \francis{ \em [the + sign is correct.]}

\begin{corollary} Given the formulation of random variables, the
  pdf of $Z$ can be written as 
  \begin{align}
  f_{Z}(z) &= \left|\frac{1}{h}\right|\int_0^1 c_{X, Y} \left[
  F_{Y}\left\{\frac{F^{(-1)}_{X}(u)-z}{h}\right\}, u
  \right]
   \cdot
  f_{Y}
  \left\{\frac{F^{(-1)}_{X}(u)-z}{h}\right\} du, \label{eq:density1}
  \end{align} or
    \begin{align}
      f_{Z}(z)
      = \int_0^1 c_{X, Y} \left[
      F_{X}\left\{z + h F^{(-1)}_{Y}(u)\right\}, u
      \right]
       \cdot
      f_{X}
      \left\{
      z+ hF^{(-1)}_{Y}(u)
      \right\} du. \label{eq:density2}
  \end{align}
  \end{corollary}
The two expressions are equivalent.
Note that the pdf of $Z$ in the above proposition can be assessed via numerical integration
as long as we have the copula density and the marginal
densities.
A generic expression and proof can be found in the
appendix.

\subsection{Procedure to determine optimal hedge ratio}\label{sec:empirical-procedure}
We introduce the empirical procedure to obtain the optimal hedge ratio (OHR) being used in this work.
First, we split the time series of spot and futures into sets of
training and testing data.
The training data makes up the first 300
observations and its corresponding testing data consists of the
consecutive 5 observations.
We then roll 5 observations forward (step size of 5) to obtain the next training and
test data sets and repeat this until the end of the time series. 
Note that the testing data are non-overlapping since the step size and equal to test size.

Next, we obtain the OHR as follows:

\begin{enumerate}
\item \textbf{Construct Univariate Kernel Density Function (KDE)}.
  From the training data we calibrate the spot and futures'
  univariate kernel density functions using the Gaussian kernel with
  bandwidth determined by the refined plug-in method \citep[section
  3.3.3]{hardle2004nonparametric}.
\item \textbf{Calibrate Copulae}.
  We then calibrate the copulae outlined in section \ref{subsec:copulae} via the
  method of moments described in section \ref{subsec:simulated-method-of-moments}.
\item \textbf{Select Copula}.
  We compute the Akaike Information Criterion. The copula with the
  best (i.e., lowest) AIC is used for the next step. 
  A discussion of this step is found in \ref{subsec:copula-selection}.
\item \textbf{Determine OHR}.
  We determine the OHRs numerically using different risk measures as
  the loss function by drawing samples from the selected copula and
  KDEs. The risk measures used as risk reduction objectives are
  outlined in \ref{subsec:spectral-risk-measures} 
  \item \textbf{Obtain testing log-return of hedged portfolio}.
  Finally, we apply the OHRs to the test data $R_h = R_s - h^* R_f$.
  \end{enumerate}

\section{Copulae and risk measures}\label{sec:crm}
\input{copulae.tex}
% ----------------
% --- Copulae's definition and properties ---
% ----------------

\input{estimation.tex}
% ----------------
% --- Estimation of Copula ---
% ----------------

\input{copulaselection.tex}


\input{riskmeasures.tex}
% ----------------
% --- Risk measures' definition and properties ---
% ----------------
